import { c as createAstro, a as createComponent, r as renderTemplate, b as renderHead } from '../entry.mjs';
import Slugger from 'github-slugger';
import '@astrojs/netlify/netlify-functions.js';
import 'preact';
import 'preact-render-to-string';
import 'vue';
import 'vue/server-renderer';
import 'html-escaper';
import 'node-html-parser';
import 'axios';
/* empty css                           *//* empty css                           *//* empty css                           */import '@storyblok/js';
/* empty css                          *//* empty css                              */import 'clone-deep';
import 'slugify';
import 'shiki';
/* empty css                           */import 'camelcase';
/* empty css                              */import '@astrojs/rss';
/* empty css                           */import 'mime';
import 'cookie';
import 'kleur/colors';
import 'string-width';
import 'path-browserify';
import 'path-to-regexp';

const metadata = { "headings": [{ "depth": 2, "slug": "open-websocket-channel", "text": "Open WebSocket Channel" }, { "depth": 2, "slug": "fetch-hosted-audio-stream", "text": "Fetch Hosted Audio Stream" }, { "depth": 2, "slug": "read-chunks-and-send-to-deepgram", "text": "Read Chunks and Send to Deepgram" }, { "depth": 2, "slug": "finishing-up", "text": "Finishing Up" }], "source": "\nToday we'll look at how to fetch an audio stream from a URL, send the stream data to Deepgram, and receive transcriptions in return. This is particularly useful when you want to get live stream data and send it in real-time (and also receive a transcription back from Deepgram in real-time chunks).\n\nThis will require three main steps:\n\n1.  Open a WebSocket channel to Deepgram\n2.  Request the hosted audio stream data from the URL where the stream is hosted (using Fetch)\n3.  Pass the stream in incremental chunks to Deepgram\n\nIf you want to see the audio stream transcribed by Deepgram's speech-to-text API, I recommend signing up for a free account and getting an API key [here](https://console.deepgram.com/signup?jump=keys).\n\n## Open WebSocket Channel\n\nThe very first thing we need to do is connect to Deepgram with a browser WebSocket.\n\n```js\nconst socket = new WebSocket('wss://api.deepgram.com/v1/listen', [\r\n  'token',\r\n  'YOUR_DEEPGRAM_API_KEY',\r\n])\n```\n\nNext we'll write several event listeners. **Events** are actions that occur within a programmed system; the system is designed to inform us of those events so that we can write code in reaction to them. The WebSocket API includes several events that fire throughout the process of the socket opening, data being received, and the socket closing. We'll use an event listener to react to those events.\n\nWe write this WebSocket logic first because then we can listen for the `onopen` event to take place, and once it does, we make the fetch request to receive the audio file:\n\n```js\nsocket.onopen = () => {\r\n  // Fetch stream\r\n  // Send stream to Deepgram\r\n}\r\n\r\nsocket.onmessage = (message) => {\r\n  // Receive transcript from Deepgram\r\n  // Do something with transcript\r\n}\r\n\r\nsocket.onclose = () => {\r\n  console.log({ event: 'onclose' })\r\n}\r\n\r\nsocket.onerror = (error) => {\r\n  console.log({ event: 'onerror', error })\r\n}\n```\n\n## Fetch Hosted Audio Stream\n\nThe next step will be to write the fetch request. The browser's global `fetch()` method takes a string parameter that is the URL to where we will be making the request.\n\nThe method returns a promise, so we can chain `.then()` to wait for the response and get the response body.\n\n```js\nsocket.onopen = () => {\r\n  const url =\r\n    'https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk'\r\n\r\n  fetch(url)\r\n    .then((response) => response.body)\r\n    .then((body) => {\r\n      // Send stream to Deepgram\r\n    })\r\n}\n```\n\n## Read Chunks and Send to Deepgram\n\nThe `response.body` we receive from the URL will be a `ReadableStream`, which is a \"readable stream of byte data\" ([Mozilla](https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream)). This just means it is data that can be read. And in order to read the data, we must break it down - similar to the way a human must break a sentence down into words in order to comprehend its meaning.\n\nHow do we break down the stream data? The Streams API was created for this purpose. We'll use it to take the stream and break it into **chunks**, which are the single pieces of data that are written to or read from a stream.\n\nWe can write a function to consume the readable stream and turn it into chunks to send to Deepgram. There are different ways to do this, but all of them will need to do the following:\n\n1.  Create a [reader](https://developer.mozilla.org/en-US/docs/Web/API/ReadableStreamDefaultReader) using the `getReader()` method\n2.  Use the `read()` method of the reader interface to get access to each chunk in the queue (returned as a promise)\n\nHere is one way to write this function:\n\n```js\nasync function readAllChunks(readableStream) {\r\n  // Create reader:\r\n  const reader = readableStream.getReader()\r\n  while (true) {\r\n    // Read chunks:\r\n    const { done, value } = await reader.read()\r\n    if (done) {\r\n      break\r\n    }\r\n    // Send chunks to Deepgram:\r\n    socket.send(value)\r\n  }\r\n}\n```\n\nSince the `.read()` method returns a promise that resolves to an object, we can destructure that object into its two properties: `done` and `value`. Then we can send that value on to Deepgram for transcription.\n\nThe Streams API specification provides [other useful examples](https://streams.spec.whatwg.org/#rs-intro) for how to consume a `ReadableStream`.\n\nNow that we have the logic to read the stream as chunks, we need to invoke the function and pass in the readable stream:\n\n```js\nsocket.onopen = () => {\r\n  const url =\r\n    'https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk'\r\n\r\n  fetch(url)\r\n    .then((response) => response.body)\r\n    .then((body) => {\r\n      // Invoke function that sends readable stream:\r\n      readAllChunks(body)\r\n    })\r\n}\n```\n\n## Finishing Up\n\nWe have accomplished what we set out to do, which is to get a hosted audio stream and send it to Deepgram to be transcribed in realtime. When the transcript is returned, we can do whatever it is we intended to do with it.\n\nHere's the code in its entirety. I've also included [an example](https://stackblitz.com/edit/web-platform-v9nyiq?file=script.js,index.html) in my Stackblitz account that puts the text from the stream onto the browser page. Be sure to add an API key to make it work.\n\n```js\nconst socket = new WebSocket('wss://api.deepgram.com/v1/listen', [\r\n  'token',\r\n  'YOUR_DEEPGRAM_API_KEY',\r\n])\r\n\r\nsocket.onopen = () => {\r\n  const url =\r\n    'https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk'\r\n  fetch(url)\r\n    .then((response) => response.body)\r\n    .then((body) => {\r\n      readAllChunks(body)\r\n    })\r\n}\r\n\r\nasync function readAllChunks(readableStream) {\r\n  const reader = readableStream.getReader()\r\n  while (true) {\r\n    const { done, value } = await reader.read()\r\n    if (done) {\r\n      break\r\n    }\r\n    socket.send(value)\r\n  }\r\n}\r\n\r\nsocket.onmessage = (message) => {\r\n  const received = JSON.parse(message.data)\r\n  const transcript = received.channel.alternatives[0].transcript\r\n  if (transcript && received.is_final) {\r\n    document.querySelector('#captions').textContent += transcript + ' '\r\n  }\r\n}\r\n\r\nsocket.onclose = () => {\r\n  console.log({ event: 'onclose' })\r\n}\r\n\r\nsocket.onerror = (error) => {\r\n  console.log({ event: 'onerror', error })\r\n}\n```\n\nHave questions? We're happy to help [@DeepgramDevs.](https://twitter.com/DeepgramDevs)\n\n        ", "html": '<p>Today we\u2019ll look at how to fetch an audio stream from a URL, send the stream data to Deepgram, and receive transcriptions in return. This is particularly useful when you want to get live stream data and send it in real-time (and also receive a transcription back from Deepgram in real-time chunks).</p>\n<p>This will require three main steps:</p>\n<ol>\n<li>Open a WebSocket channel to Deepgram</li>\n<li>Request the hosted audio stream data from the URL where the stream is hosted (using Fetch)</li>\n<li>Pass the stream in incremental chunks to Deepgram</li>\n</ol>\n<p>If you want to see the audio stream transcribed by Deepgram\u2019s speech-to-text API, I recommend signing up for a free account and getting an API key <a href="https://console.deepgram.com/signup?jump=keys">here</a>.</p>\n<h2 id="open-websocket-channel">Open WebSocket Channel</h2>\n<p>The very first thing we need to do is connect to Deepgram with a browser WebSocket.</p>\n<pre is:raw class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">socket</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">WebSocket</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;wss://api.deepgram.com/v1/listen&#39;</span><span style="color: #C9D1D9">, [</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">&#39;token&#39;</span><span style="color: #C9D1D9">,</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">&#39;YOUR_DEEPGRAM_API_KEY&#39;</span><span style="color: #C9D1D9">,</span></span>\n<span class="line"><span style="color: #C9D1D9">])</span></span></code></pre>\n<p>Next we\u2019ll write several event listeners. <strong>Events</strong> are actions that occur within a programmed system; the system is designed to inform us of those events so that we can write code in reaction to them. The WebSocket API includes several events that fire throughout the process of the socket opening, data being received, and the socket closing. We\u2019ll use an event listener to react to those events.</p>\n<p>We write this WebSocket logic first because then we can listen for the <code is:raw>onopen</code> event to take place, and once it does, we make the fetch request to receive the audio file:</p>\n<pre is:raw class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onopen</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Fetch stream</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Send stream to Deepgram</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onmessage</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">message</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Receive transcript from Deepgram</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Do something with transcript</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onclose</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">({ event: </span><span style="color: #A5D6FF">&#39;onclose&#39;</span><span style="color: #C9D1D9"> })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onerror</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">error</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">({ event: </span><span style="color: #A5D6FF">&#39;onerror&#39;</span><span style="color: #C9D1D9">, error })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>\n<h2 id="fetch-hosted-audio-stream">Fetch Hosted Audio Stream</h2>\n<p>The next step will be to write the fetch request. The browser\u2019s global <code is:raw>fetch()</code> method takes a string parameter that is the URL to where we will be making the request.</p>\n<p>The method returns a promise, so we can chain <code is:raw>.then()</code> to wait for the response and get the response body.</p>\n<pre is:raw class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onopen</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">url</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">&#39;https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk&#39;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">fetch</span><span style="color: #C9D1D9">(url)</span></span>\n<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">response</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> response.body)</span></span>\n<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">body</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #8B949E">// Send stream to Deepgram</span></span>\n<span class="line"><span style="color: #C9D1D9">    })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>\n<h2 id="read-chunks-and-send-to-deepgram">Read Chunks and Send to Deepgram</h2>\n<p>The <code is:raw>response.body</code> we receive from the URL will be a <code is:raw>ReadableStream</code>, which is a \u201Creadable stream of byte data\u201D (<a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream">Mozilla</a>). This just means it is data that can be read. And in order to read the data, we must break it down - similar to the way a human must break a sentence down into words in order to comprehend its meaning.</p>\n<p>How do we break down the stream data? The Streams API was created for this purpose. We\u2019ll use it to take the stream and break it into <strong>chunks</strong>, which are the single pieces of data that are written to or read from a stream.</p>\n<p>We can write a function to consume the readable stream and turn it into chunks to send to Deepgram. There are different ways to do this, but all of them will need to do the following:</p>\n<ol>\n<li>Create a <a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStreamDefaultReader">reader</a> using the <code is:raw>getReader()</code> method</li>\n<li>Use the <code is:raw>read()</code> method of the reader interface to get access to each chunk in the queue (returned as a promise)</li>\n</ol>\n<p>Here is one way to write this function:</p>\n<pre is:raw class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">readAllChunks</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">readableStream</span><span style="color: #C9D1D9">) {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Create reader:</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">reader</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> readableStream.</span><span style="color: #D2A8FF">getReader</span><span style="color: #C9D1D9">()</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">) {</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// Read chunks:</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #79C0FF">done</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">value</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> reader.</span><span style="color: #D2A8FF">read</span><span style="color: #C9D1D9">()</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (done) {</span></span>\n<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">break</span></span>\n<span class="line"><span style="color: #C9D1D9">    }</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// Send chunks to Deepgram:</span></span>\n<span class="line"><span style="color: #C9D1D9">    socket.</span><span style="color: #D2A8FF">send</span><span style="color: #C9D1D9">(value)</span></span>\n<span class="line"><span style="color: #C9D1D9">  }</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>\n<p>Since the <code is:raw>.read()</code> method returns a promise that resolves to an object, we can destructure that object into its two properties: <code is:raw>done</code> and <code is:raw>value</code>. Then we can send that value on to Deepgram for transcription.</p>\n<p>The Streams API specification provides <a href="https://streams.spec.whatwg.org/#rs-intro">other useful examples</a> for how to consume a <code is:raw>ReadableStream</code>.</p>\n<p>Now that we have the logic to read the stream as chunks, we need to invoke the function and pass in the readable stream:</p>\n<pre is:raw class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onopen</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">url</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">&#39;https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk&#39;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">fetch</span><span style="color: #C9D1D9">(url)</span></span>\n<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">response</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> response.body)</span></span>\n<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">body</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #8B949E">// Invoke function that sends readable stream:</span></span>\n<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">readAllChunks</span><span style="color: #C9D1D9">(body)</span></span>\n<span class="line"><span style="color: #C9D1D9">    })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>\n<h2 id="finishing-up">Finishing Up</h2>\n<p>We have accomplished what we set out to do, which is to get a hosted audio stream and send it to Deepgram to be transcribed in realtime. When the transcript is returned, we can do whatever it is we intended to do with it.</p>\n<p>Here\u2019s the code in its entirety. I\u2019ve also included <a href="https://stackblitz.com/edit/web-platform-v9nyiq?file=script.js,index.html">an example</a> in my Stackblitz account that puts the text from the stream onto the browser page. Be sure to add an API key to make it work.</p>\n<pre is:raw class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">socket</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">WebSocket</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;wss://api.deepgram.com/v1/listen&#39;</span><span style="color: #C9D1D9">, [</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">&#39;token&#39;</span><span style="color: #C9D1D9">,</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">&#39;YOUR_DEEPGRAM_API_KEY&#39;</span><span style="color: #C9D1D9">,</span></span>\n<span class="line"><span style="color: #C9D1D9">])</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onopen</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">url</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">&#39;https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk&#39;</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">fetch</span><span style="color: #C9D1D9">(url)</span></span>\n<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">response</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> response.body)</span></span>\n<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">body</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">readAllChunks</span><span style="color: #C9D1D9">(body)</span></span>\n<span class="line"><span style="color: #C9D1D9">    })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">readAllChunks</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">readableStream</span><span style="color: #C9D1D9">) {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">reader</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> readableStream.</span><span style="color: #D2A8FF">getReader</span><span style="color: #C9D1D9">()</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">) {</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #79C0FF">done</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">value</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> reader.</span><span style="color: #D2A8FF">read</span><span style="color: #C9D1D9">()</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (done) {</span></span>\n<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">break</span></span>\n<span class="line"><span style="color: #C9D1D9">    }</span></span>\n<span class="line"><span style="color: #C9D1D9">    socket.</span><span style="color: #D2A8FF">send</span><span style="color: #C9D1D9">(value)</span></span>\n<span class="line"><span style="color: #C9D1D9">  }</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onmessage</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">message</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">received</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">JSON</span><span style="color: #C9D1D9">.</span><span style="color: #D2A8FF">parse</span><span style="color: #C9D1D9">(message.data)</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">transcript</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> received.channel.alternatives[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">].transcript</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (transcript </span><span style="color: #FF7B72">&amp;&amp;</span><span style="color: #C9D1D9"> received.is_final) {</span></span>\n<span class="line"><span style="color: #C9D1D9">    document.</span><span style="color: #D2A8FF">querySelector</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;#captions&#39;</span><span style="color: #C9D1D9">).textContent </span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> transcript </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#39; &#39;</span></span>\n<span class="line"><span style="color: #C9D1D9">  }</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onclose</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">({ event: </span><span style="color: #A5D6FF">&#39;onclose&#39;</span><span style="color: #C9D1D9"> })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onerror</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">error</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">({ event: </span><span style="color: #A5D6FF">&#39;onerror&#39;</span><span style="color: #C9D1D9">, error })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>\n<p>Have questions? We\u2019re happy to help <a href="https://twitter.com/DeepgramDevs">@DeepgramDevs.</a></p>' };
const frontmatter = { "title": "Fetch Hosted Audio Streams In The Browser", "description": "Learn how to fetch an audio stream from a URL, break down a readable stream into chunks using the JavaScript Streams API, and send the audio stream through a WebSocket to Deepgram.", "date": "2022-06-16T00:00:00.000Z", "cover": "https://res.cloudinary.com/deepgram/image/upload/v1655135180/blog/2022/06/fetch-hosted-audio-streams-in-the-browser/How-to-fetch-hosted-audio-streams-in-the-browser-blog.png", "authors": ["sandra-rodgers"], "category": "tutorial", "tags": ["websockets", "browser", "javascript"], "seo": { "title": "Fetch Hosted Audio Streams In The Browser", "description": "Learn how to fetch an audio stream from a URL, break down a readable stream into chunks using the JavaScript Streams API, and send the audio stream through a WebSocket to Deepgram." }, "shorturls": { "share": "https://dpgr.am/1aab758", "twitter": "https://dpgr.am/754f7d0", "linkedin": "https://dpgr.am/d758df7", "reddit": "https://dpgr.am/5ef955f", "facebook": "https://dpgr.am/590f31a" }, "og": { "image": "https://res.cloudinary.com/deepgram/image/upload/v1661454096/blog/fetch-hosted-audio-streams-in-the-browser/ograph.png" }, "astro": { "headings": [{ "depth": 2, "slug": "open-websocket-channel", "text": "Open WebSocket Channel" }, { "depth": 2, "slug": "fetch-hosted-audio-stream", "text": "Fetch Hosted Audio Stream" }, { "depth": 2, "slug": "read-chunks-and-send-to-deepgram", "text": "Read Chunks and Send to Deepgram" }, { "depth": 2, "slug": "finishing-up", "text": "Finishing Up" }], "source": "\nToday we'll look at how to fetch an audio stream from a URL, send the stream data to Deepgram, and receive transcriptions in return. This is particularly useful when you want to get live stream data and send it in real-time (and also receive a transcription back from Deepgram in real-time chunks).\n\nThis will require three main steps:\n\n1.  Open a WebSocket channel to Deepgram\n2.  Request the hosted audio stream data from the URL where the stream is hosted (using Fetch)\n3.  Pass the stream in incremental chunks to Deepgram\n\nIf you want to see the audio stream transcribed by Deepgram's speech-to-text API, I recommend signing up for a free account and getting an API key [here](https://console.deepgram.com/signup?jump=keys).\n\n## Open WebSocket Channel\n\nThe very first thing we need to do is connect to Deepgram with a browser WebSocket.\n\n```js\nconst socket = new WebSocket('wss://api.deepgram.com/v1/listen', [\r\n  'token',\r\n  'YOUR_DEEPGRAM_API_KEY',\r\n])\n```\n\nNext we'll write several event listeners. **Events** are actions that occur within a programmed system; the system is designed to inform us of those events so that we can write code in reaction to them. The WebSocket API includes several events that fire throughout the process of the socket opening, data being received, and the socket closing. We'll use an event listener to react to those events.\n\nWe write this WebSocket logic first because then we can listen for the `onopen` event to take place, and once it does, we make the fetch request to receive the audio file:\n\n```js\nsocket.onopen = () => {\r\n  // Fetch stream\r\n  // Send stream to Deepgram\r\n}\r\n\r\nsocket.onmessage = (message) => {\r\n  // Receive transcript from Deepgram\r\n  // Do something with transcript\r\n}\r\n\r\nsocket.onclose = () => {\r\n  console.log({ event: 'onclose' })\r\n}\r\n\r\nsocket.onerror = (error) => {\r\n  console.log({ event: 'onerror', error })\r\n}\n```\n\n## Fetch Hosted Audio Stream\n\nThe next step will be to write the fetch request. The browser's global `fetch()` method takes a string parameter that is the URL to where we will be making the request.\n\nThe method returns a promise, so we can chain `.then()` to wait for the response and get the response body.\n\n```js\nsocket.onopen = () => {\r\n  const url =\r\n    'https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk'\r\n\r\n  fetch(url)\r\n    .then((response) => response.body)\r\n    .then((body) => {\r\n      // Send stream to Deepgram\r\n    })\r\n}\n```\n\n## Read Chunks and Send to Deepgram\n\nThe `response.body` we receive from the URL will be a `ReadableStream`, which is a \"readable stream of byte data\" ([Mozilla](https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream)). This just means it is data that can be read. And in order to read the data, we must break it down - similar to the way a human must break a sentence down into words in order to comprehend its meaning.\n\nHow do we break down the stream data? The Streams API was created for this purpose. We'll use it to take the stream and break it into **chunks**, which are the single pieces of data that are written to or read from a stream.\n\nWe can write a function to consume the readable stream and turn it into chunks to send to Deepgram. There are different ways to do this, but all of them will need to do the following:\n\n1.  Create a [reader](https://developer.mozilla.org/en-US/docs/Web/API/ReadableStreamDefaultReader) using the `getReader()` method\n2.  Use the `read()` method of the reader interface to get access to each chunk in the queue (returned as a promise)\n\nHere is one way to write this function:\n\n```js\nasync function readAllChunks(readableStream) {\r\n  // Create reader:\r\n  const reader = readableStream.getReader()\r\n  while (true) {\r\n    // Read chunks:\r\n    const { done, value } = await reader.read()\r\n    if (done) {\r\n      break\r\n    }\r\n    // Send chunks to Deepgram:\r\n    socket.send(value)\r\n  }\r\n}\n```\n\nSince the `.read()` method returns a promise that resolves to an object, we can destructure that object into its two properties: `done` and `value`. Then we can send that value on to Deepgram for transcription.\n\nThe Streams API specification provides [other useful examples](https://streams.spec.whatwg.org/#rs-intro) for how to consume a `ReadableStream`.\n\nNow that we have the logic to read the stream as chunks, we need to invoke the function and pass in the readable stream:\n\n```js\nsocket.onopen = () => {\r\n  const url =\r\n    'https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk'\r\n\r\n  fetch(url)\r\n    .then((response) => response.body)\r\n    .then((body) => {\r\n      // Invoke function that sends readable stream:\r\n      readAllChunks(body)\r\n    })\r\n}\n```\n\n## Finishing Up\n\nWe have accomplished what we set out to do, which is to get a hosted audio stream and send it to Deepgram to be transcribed in realtime. When the transcript is returned, we can do whatever it is we intended to do with it.\n\nHere's the code in its entirety. I've also included [an example](https://stackblitz.com/edit/web-platform-v9nyiq?file=script.js,index.html) in my Stackblitz account that puts the text from the stream onto the browser page. Be sure to add an API key to make it work.\n\n```js\nconst socket = new WebSocket('wss://api.deepgram.com/v1/listen', [\r\n  'token',\r\n  'YOUR_DEEPGRAM_API_KEY',\r\n])\r\n\r\nsocket.onopen = () => {\r\n  const url =\r\n    'https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk'\r\n  fetch(url)\r\n    .then((response) => response.body)\r\n    .then((body) => {\r\n      readAllChunks(body)\r\n    })\r\n}\r\n\r\nasync function readAllChunks(readableStream) {\r\n  const reader = readableStream.getReader()\r\n  while (true) {\r\n    const { done, value } = await reader.read()\r\n    if (done) {\r\n      break\r\n    }\r\n    socket.send(value)\r\n  }\r\n}\r\n\r\nsocket.onmessage = (message) => {\r\n  const received = JSON.parse(message.data)\r\n  const transcript = received.channel.alternatives[0].transcript\r\n  if (transcript && received.is_final) {\r\n    document.querySelector('#captions').textContent += transcript + ' '\r\n  }\r\n}\r\n\r\nsocket.onclose = () => {\r\n  console.log({ event: 'onclose' })\r\n}\r\n\r\nsocket.onerror = (error) => {\r\n  console.log({ event: 'onerror', error })\r\n}\n```\n\nHave questions? We're happy to help [@DeepgramDevs.](https://twitter.com/DeepgramDevs)\n\n        ", "html": '<p>Today we\u2019ll look at how to fetch an audio stream from a URL, send the stream data to Deepgram, and receive transcriptions in return. This is particularly useful when you want to get live stream data and send it in real-time (and also receive a transcription back from Deepgram in real-time chunks).</p>\n<p>This will require three main steps:</p>\n<ol>\n<li>Open a WebSocket channel to Deepgram</li>\n<li>Request the hosted audio stream data from the URL where the stream is hosted (using Fetch)</li>\n<li>Pass the stream in incremental chunks to Deepgram</li>\n</ol>\n<p>If you want to see the audio stream transcribed by Deepgram\u2019s speech-to-text API, I recommend signing up for a free account and getting an API key <a href="https://console.deepgram.com/signup?jump=keys">here</a>.</p>\n<h2 id="open-websocket-channel">Open WebSocket Channel</h2>\n<p>The very first thing we need to do is connect to Deepgram with a browser WebSocket.</p>\n<pre is:raw class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">socket</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">WebSocket</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;wss://api.deepgram.com/v1/listen&#39;</span><span style="color: #C9D1D9">, [</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">&#39;token&#39;</span><span style="color: #C9D1D9">,</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">&#39;YOUR_DEEPGRAM_API_KEY&#39;</span><span style="color: #C9D1D9">,</span></span>\n<span class="line"><span style="color: #C9D1D9">])</span></span></code></pre>\n<p>Next we\u2019ll write several event listeners. <strong>Events</strong> are actions that occur within a programmed system; the system is designed to inform us of those events so that we can write code in reaction to them. The WebSocket API includes several events that fire throughout the process of the socket opening, data being received, and the socket closing. We\u2019ll use an event listener to react to those events.</p>\n<p>We write this WebSocket logic first because then we can listen for the <code is:raw>onopen</code> event to take place, and once it does, we make the fetch request to receive the audio file:</p>\n<pre is:raw class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onopen</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Fetch stream</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Send stream to Deepgram</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onmessage</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">message</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Receive transcript from Deepgram</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Do something with transcript</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onclose</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">({ event: </span><span style="color: #A5D6FF">&#39;onclose&#39;</span><span style="color: #C9D1D9"> })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onerror</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">error</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">({ event: </span><span style="color: #A5D6FF">&#39;onerror&#39;</span><span style="color: #C9D1D9">, error })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>\n<h2 id="fetch-hosted-audio-stream">Fetch Hosted Audio Stream</h2>\n<p>The next step will be to write the fetch request. The browser\u2019s global <code is:raw>fetch()</code> method takes a string parameter that is the URL to where we will be making the request.</p>\n<p>The method returns a promise, so we can chain <code is:raw>.then()</code> to wait for the response and get the response body.</p>\n<pre is:raw class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onopen</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">url</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">&#39;https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk&#39;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">fetch</span><span style="color: #C9D1D9">(url)</span></span>\n<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">response</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> response.body)</span></span>\n<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">body</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #8B949E">// Send stream to Deepgram</span></span>\n<span class="line"><span style="color: #C9D1D9">    })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>\n<h2 id="read-chunks-and-send-to-deepgram">Read Chunks and Send to Deepgram</h2>\n<p>The <code is:raw>response.body</code> we receive from the URL will be a <code is:raw>ReadableStream</code>, which is a \u201Creadable stream of byte data\u201D (<a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream">Mozilla</a>). This just means it is data that can be read. And in order to read the data, we must break it down - similar to the way a human must break a sentence down into words in order to comprehend its meaning.</p>\n<p>How do we break down the stream data? The Streams API was created for this purpose. We\u2019ll use it to take the stream and break it into <strong>chunks</strong>, which are the single pieces of data that are written to or read from a stream.</p>\n<p>We can write a function to consume the readable stream and turn it into chunks to send to Deepgram. There are different ways to do this, but all of them will need to do the following:</p>\n<ol>\n<li>Create a <a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStreamDefaultReader">reader</a> using the <code is:raw>getReader()</code> method</li>\n<li>Use the <code is:raw>read()</code> method of the reader interface to get access to each chunk in the queue (returned as a promise)</li>\n</ol>\n<p>Here is one way to write this function:</p>\n<pre is:raw class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">readAllChunks</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">readableStream</span><span style="color: #C9D1D9">) {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Create reader:</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">reader</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> readableStream.</span><span style="color: #D2A8FF">getReader</span><span style="color: #C9D1D9">()</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">) {</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// Read chunks:</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #79C0FF">done</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">value</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> reader.</span><span style="color: #D2A8FF">read</span><span style="color: #C9D1D9">()</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (done) {</span></span>\n<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">break</span></span>\n<span class="line"><span style="color: #C9D1D9">    }</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// Send chunks to Deepgram:</span></span>\n<span class="line"><span style="color: #C9D1D9">    socket.</span><span style="color: #D2A8FF">send</span><span style="color: #C9D1D9">(value)</span></span>\n<span class="line"><span style="color: #C9D1D9">  }</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>\n<p>Since the <code is:raw>.read()</code> method returns a promise that resolves to an object, we can destructure that object into its two properties: <code is:raw>done</code> and <code is:raw>value</code>. Then we can send that value on to Deepgram for transcription.</p>\n<p>The Streams API specification provides <a href="https://streams.spec.whatwg.org/#rs-intro">other useful examples</a> for how to consume a <code is:raw>ReadableStream</code>.</p>\n<p>Now that we have the logic to read the stream as chunks, we need to invoke the function and pass in the readable stream:</p>\n<pre is:raw class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onopen</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">url</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">&#39;https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk&#39;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">fetch</span><span style="color: #C9D1D9">(url)</span></span>\n<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">response</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> response.body)</span></span>\n<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">body</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #8B949E">// Invoke function that sends readable stream:</span></span>\n<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">readAllChunks</span><span style="color: #C9D1D9">(body)</span></span>\n<span class="line"><span style="color: #C9D1D9">    })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>\n<h2 id="finishing-up">Finishing Up</h2>\n<p>We have accomplished what we set out to do, which is to get a hosted audio stream and send it to Deepgram to be transcribed in realtime. When the transcript is returned, we can do whatever it is we intended to do with it.</p>\n<p>Here\u2019s the code in its entirety. I\u2019ve also included <a href="https://stackblitz.com/edit/web-platform-v9nyiq?file=script.js,index.html">an example</a> in my Stackblitz account that puts the text from the stream onto the browser page. Be sure to add an API key to make it work.</p>\n<pre is:raw class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">socket</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">WebSocket</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;wss://api.deepgram.com/v1/listen&#39;</span><span style="color: #C9D1D9">, [</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">&#39;token&#39;</span><span style="color: #C9D1D9">,</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">&#39;YOUR_DEEPGRAM_API_KEY&#39;</span><span style="color: #C9D1D9">,</span></span>\n<span class="line"><span style="color: #C9D1D9">])</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onopen</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">url</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">&#39;https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk&#39;</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">fetch</span><span style="color: #C9D1D9">(url)</span></span>\n<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">response</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> response.body)</span></span>\n<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">body</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">readAllChunks</span><span style="color: #C9D1D9">(body)</span></span>\n<span class="line"><span style="color: #C9D1D9">    })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">readAllChunks</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">readableStream</span><span style="color: #C9D1D9">) {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">reader</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> readableStream.</span><span style="color: #D2A8FF">getReader</span><span style="color: #C9D1D9">()</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">) {</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #79C0FF">done</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">value</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> reader.</span><span style="color: #D2A8FF">read</span><span style="color: #C9D1D9">()</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (done) {</span></span>\n<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">break</span></span>\n<span class="line"><span style="color: #C9D1D9">    }</span></span>\n<span class="line"><span style="color: #C9D1D9">    socket.</span><span style="color: #D2A8FF">send</span><span style="color: #C9D1D9">(value)</span></span>\n<span class="line"><span style="color: #C9D1D9">  }</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onmessage</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">message</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">received</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">JSON</span><span style="color: #C9D1D9">.</span><span style="color: #D2A8FF">parse</span><span style="color: #C9D1D9">(message.data)</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">transcript</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> received.channel.alternatives[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">].transcript</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (transcript </span><span style="color: #FF7B72">&amp;&amp;</span><span style="color: #C9D1D9"> received.is_final) {</span></span>\n<span class="line"><span style="color: #C9D1D9">    document.</span><span style="color: #D2A8FF">querySelector</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;#captions&#39;</span><span style="color: #C9D1D9">).textContent </span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> transcript </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#39; &#39;</span></span>\n<span class="line"><span style="color: #C9D1D9">  }</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onclose</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">({ event: </span><span style="color: #A5D6FF">&#39;onclose&#39;</span><span style="color: #C9D1D9"> })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onerror</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">error</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">({ event: </span><span style="color: #A5D6FF">&#39;onerror&#39;</span><span style="color: #C9D1D9">, error })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>\n<p>Have questions? We\u2019re happy to help <a href="https://twitter.com/DeepgramDevs">@DeepgramDevs.</a></p>' }, "file": "/Users/sandrarodgers/web-next/blog/src/content/blog/posts/fetch-hosted-audio-streams-in-the-browser/index.md" };
function rawContent() {
  return "\nToday we'll look at how to fetch an audio stream from a URL, send the stream data to Deepgram, and receive transcriptions in return. This is particularly useful when you want to get live stream data and send it in real-time (and also receive a transcription back from Deepgram in real-time chunks).\n\nThis will require three main steps:\n\n1.  Open a WebSocket channel to Deepgram\n2.  Request the hosted audio stream data from the URL where the stream is hosted (using Fetch)\n3.  Pass the stream in incremental chunks to Deepgram\n\nIf you want to see the audio stream transcribed by Deepgram's speech-to-text API, I recommend signing up for a free account and getting an API key [here](https://console.deepgram.com/signup?jump=keys).\n\n## Open WebSocket Channel\n\nThe very first thing we need to do is connect to Deepgram with a browser WebSocket.\n\n```js\nconst socket = new WebSocket('wss://api.deepgram.com/v1/listen', [\r\n  'token',\r\n  'YOUR_DEEPGRAM_API_KEY',\r\n])\n```\n\nNext we'll write several event listeners. **Events** are actions that occur within a programmed system; the system is designed to inform us of those events so that we can write code in reaction to them. The WebSocket API includes several events that fire throughout the process of the socket opening, data being received, and the socket closing. We'll use an event listener to react to those events.\n\nWe write this WebSocket logic first because then we can listen for the `onopen` event to take place, and once it does, we make the fetch request to receive the audio file:\n\n```js\nsocket.onopen = () => {\r\n  // Fetch stream\r\n  // Send stream to Deepgram\r\n}\r\n\r\nsocket.onmessage = (message) => {\r\n  // Receive transcript from Deepgram\r\n  // Do something with transcript\r\n}\r\n\r\nsocket.onclose = () => {\r\n  console.log({ event: 'onclose' })\r\n}\r\n\r\nsocket.onerror = (error) => {\r\n  console.log({ event: 'onerror', error })\r\n}\n```\n\n## Fetch Hosted Audio Stream\n\nThe next step will be to write the fetch request. The browser's global `fetch()` method takes a string parameter that is the URL to where we will be making the request.\n\nThe method returns a promise, so we can chain `.then()` to wait for the response and get the response body.\n\n```js\nsocket.onopen = () => {\r\n  const url =\r\n    'https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk'\r\n\r\n  fetch(url)\r\n    .then((response) => response.body)\r\n    .then((body) => {\r\n      // Send stream to Deepgram\r\n    })\r\n}\n```\n\n## Read Chunks and Send to Deepgram\n\nThe `response.body` we receive from the URL will be a `ReadableStream`, which is a \"readable stream of byte data\" ([Mozilla](https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream)). This just means it is data that can be read. And in order to read the data, we must break it down - similar to the way a human must break a sentence down into words in order to comprehend its meaning.\n\nHow do we break down the stream data? The Streams API was created for this purpose. We'll use it to take the stream and break it into **chunks**, which are the single pieces of data that are written to or read from a stream.\n\nWe can write a function to consume the readable stream and turn it into chunks to send to Deepgram. There are different ways to do this, but all of them will need to do the following:\n\n1.  Create a [reader](https://developer.mozilla.org/en-US/docs/Web/API/ReadableStreamDefaultReader) using the `getReader()` method\n2.  Use the `read()` method of the reader interface to get access to each chunk in the queue (returned as a promise)\n\nHere is one way to write this function:\n\n```js\nasync function readAllChunks(readableStream) {\r\n  // Create reader:\r\n  const reader = readableStream.getReader()\r\n  while (true) {\r\n    // Read chunks:\r\n    const { done, value } = await reader.read()\r\n    if (done) {\r\n      break\r\n    }\r\n    // Send chunks to Deepgram:\r\n    socket.send(value)\r\n  }\r\n}\n```\n\nSince the `.read()` method returns a promise that resolves to an object, we can destructure that object into its two properties: `done` and `value`. Then we can send that value on to Deepgram for transcription.\n\nThe Streams API specification provides [other useful examples](https://streams.spec.whatwg.org/#rs-intro) for how to consume a `ReadableStream`.\n\nNow that we have the logic to read the stream as chunks, we need to invoke the function and pass in the readable stream:\n\n```js\nsocket.onopen = () => {\r\n  const url =\r\n    'https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk'\r\n\r\n  fetch(url)\r\n    .then((response) => response.body)\r\n    .then((body) => {\r\n      // Invoke function that sends readable stream:\r\n      readAllChunks(body)\r\n    })\r\n}\n```\n\n## Finishing Up\n\nWe have accomplished what we set out to do, which is to get a hosted audio stream and send it to Deepgram to be transcribed in realtime. When the transcript is returned, we can do whatever it is we intended to do with it.\n\nHere's the code in its entirety. I've also included [an example](https://stackblitz.com/edit/web-platform-v9nyiq?file=script.js,index.html) in my Stackblitz account that puts the text from the stream onto the browser page. Be sure to add an API key to make it work.\n\n```js\nconst socket = new WebSocket('wss://api.deepgram.com/v1/listen', [\r\n  'token',\r\n  'YOUR_DEEPGRAM_API_KEY',\r\n])\r\n\r\nsocket.onopen = () => {\r\n  const url =\r\n    'https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk'\r\n  fetch(url)\r\n    .then((response) => response.body)\r\n    .then((body) => {\r\n      readAllChunks(body)\r\n    })\r\n}\r\n\r\nasync function readAllChunks(readableStream) {\r\n  const reader = readableStream.getReader()\r\n  while (true) {\r\n    const { done, value } = await reader.read()\r\n    if (done) {\r\n      break\r\n    }\r\n    socket.send(value)\r\n  }\r\n}\r\n\r\nsocket.onmessage = (message) => {\r\n  const received = JSON.parse(message.data)\r\n  const transcript = received.channel.alternatives[0].transcript\r\n  if (transcript && received.is_final) {\r\n    document.querySelector('#captions').textContent += transcript + ' '\r\n  }\r\n}\r\n\r\nsocket.onclose = () => {\r\n  console.log({ event: 'onclose' })\r\n}\r\n\r\nsocket.onerror = (error) => {\r\n  console.log({ event: 'onerror', error })\r\n}\n```\n\nHave questions? We're happy to help [@DeepgramDevs.](https://twitter.com/DeepgramDevs)\n\n        ";
}
function compiledContent() {
  return '<p>Today we\u2019ll look at how to fetch an audio stream from a URL, send the stream data to Deepgram, and receive transcriptions in return. This is particularly useful when you want to get live stream data and send it in real-time (and also receive a transcription back from Deepgram in real-time chunks).</p>\n<p>This will require three main steps:</p>\n<ol>\n<li>Open a WebSocket channel to Deepgram</li>\n<li>Request the hosted audio stream data from the URL where the stream is hosted (using Fetch)</li>\n<li>Pass the stream in incremental chunks to Deepgram</li>\n</ol>\n<p>If you want to see the audio stream transcribed by Deepgram\u2019s speech-to-text API, I recommend signing up for a free account and getting an API key <a href="https://console.deepgram.com/signup?jump=keys">here</a>.</p>\n<h2 id="open-websocket-channel">Open WebSocket Channel</h2>\n<p>The very first thing we need to do is connect to Deepgram with a browser WebSocket.</p>\n<pre is:raw class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">socket</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">WebSocket</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;wss://api.deepgram.com/v1/listen&#39;</span><span style="color: #C9D1D9">, [</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">&#39;token&#39;</span><span style="color: #C9D1D9">,</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">&#39;YOUR_DEEPGRAM_API_KEY&#39;</span><span style="color: #C9D1D9">,</span></span>\n<span class="line"><span style="color: #C9D1D9">])</span></span></code></pre>\n<p>Next we\u2019ll write several event listeners. <strong>Events</strong> are actions that occur within a programmed system; the system is designed to inform us of those events so that we can write code in reaction to them. The WebSocket API includes several events that fire throughout the process of the socket opening, data being received, and the socket closing. We\u2019ll use an event listener to react to those events.</p>\n<p>We write this WebSocket logic first because then we can listen for the <code is:raw>onopen</code> event to take place, and once it does, we make the fetch request to receive the audio file:</p>\n<pre is:raw class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onopen</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Fetch stream</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Send stream to Deepgram</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onmessage</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">message</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Receive transcript from Deepgram</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Do something with transcript</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onclose</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">({ event: </span><span style="color: #A5D6FF">&#39;onclose&#39;</span><span style="color: #C9D1D9"> })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onerror</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">error</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">({ event: </span><span style="color: #A5D6FF">&#39;onerror&#39;</span><span style="color: #C9D1D9">, error })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>\n<h2 id="fetch-hosted-audio-stream">Fetch Hosted Audio Stream</h2>\n<p>The next step will be to write the fetch request. The browser\u2019s global <code is:raw>fetch()</code> method takes a string parameter that is the URL to where we will be making the request.</p>\n<p>The method returns a promise, so we can chain <code is:raw>.then()</code> to wait for the response and get the response body.</p>\n<pre is:raw class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onopen</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">url</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">&#39;https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk&#39;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">fetch</span><span style="color: #C9D1D9">(url)</span></span>\n<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">response</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> response.body)</span></span>\n<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">body</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #8B949E">// Send stream to Deepgram</span></span>\n<span class="line"><span style="color: #C9D1D9">    })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>\n<h2 id="read-chunks-and-send-to-deepgram">Read Chunks and Send to Deepgram</h2>\n<p>The <code is:raw>response.body</code> we receive from the URL will be a <code is:raw>ReadableStream</code>, which is a \u201Creadable stream of byte data\u201D (<a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream">Mozilla</a>). This just means it is data that can be read. And in order to read the data, we must break it down - similar to the way a human must break a sentence down into words in order to comprehend its meaning.</p>\n<p>How do we break down the stream data? The Streams API was created for this purpose. We\u2019ll use it to take the stream and break it into <strong>chunks</strong>, which are the single pieces of data that are written to or read from a stream.</p>\n<p>We can write a function to consume the readable stream and turn it into chunks to send to Deepgram. There are different ways to do this, but all of them will need to do the following:</p>\n<ol>\n<li>Create a <a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStreamDefaultReader">reader</a> using the <code is:raw>getReader()</code> method</li>\n<li>Use the <code is:raw>read()</code> method of the reader interface to get access to each chunk in the queue (returned as a promise)</li>\n</ol>\n<p>Here is one way to write this function:</p>\n<pre is:raw class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">readAllChunks</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">readableStream</span><span style="color: #C9D1D9">) {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Create reader:</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">reader</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> readableStream.</span><span style="color: #D2A8FF">getReader</span><span style="color: #C9D1D9">()</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">) {</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// Read chunks:</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #79C0FF">done</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">value</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> reader.</span><span style="color: #D2A8FF">read</span><span style="color: #C9D1D9">()</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (done) {</span></span>\n<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">break</span></span>\n<span class="line"><span style="color: #C9D1D9">    }</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// Send chunks to Deepgram:</span></span>\n<span class="line"><span style="color: #C9D1D9">    socket.</span><span style="color: #D2A8FF">send</span><span style="color: #C9D1D9">(value)</span></span>\n<span class="line"><span style="color: #C9D1D9">  }</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>\n<p>Since the <code is:raw>.read()</code> method returns a promise that resolves to an object, we can destructure that object into its two properties: <code is:raw>done</code> and <code is:raw>value</code>. Then we can send that value on to Deepgram for transcription.</p>\n<p>The Streams API specification provides <a href="https://streams.spec.whatwg.org/#rs-intro">other useful examples</a> for how to consume a <code is:raw>ReadableStream</code>.</p>\n<p>Now that we have the logic to read the stream as chunks, we need to invoke the function and pass in the readable stream:</p>\n<pre is:raw class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onopen</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">url</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">&#39;https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk&#39;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">fetch</span><span style="color: #C9D1D9">(url)</span></span>\n<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">response</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> response.body)</span></span>\n<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">body</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #8B949E">// Invoke function that sends readable stream:</span></span>\n<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">readAllChunks</span><span style="color: #C9D1D9">(body)</span></span>\n<span class="line"><span style="color: #C9D1D9">    })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>\n<h2 id="finishing-up">Finishing Up</h2>\n<p>We have accomplished what we set out to do, which is to get a hosted audio stream and send it to Deepgram to be transcribed in realtime. When the transcript is returned, we can do whatever it is we intended to do with it.</p>\n<p>Here\u2019s the code in its entirety. I\u2019ve also included <a href="https://stackblitz.com/edit/web-platform-v9nyiq?file=script.js,index.html">an example</a> in my Stackblitz account that puts the text from the stream onto the browser page. Be sure to add an API key to make it work.</p>\n<pre is:raw class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">socket</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">WebSocket</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;wss://api.deepgram.com/v1/listen&#39;</span><span style="color: #C9D1D9">, [</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">&#39;token&#39;</span><span style="color: #C9D1D9">,</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">&#39;YOUR_DEEPGRAM_API_KEY&#39;</span><span style="color: #C9D1D9">,</span></span>\n<span class="line"><span style="color: #C9D1D9">])</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onopen</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">url</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">&#39;https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk&#39;</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">fetch</span><span style="color: #C9D1D9">(url)</span></span>\n<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">response</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> response.body)</span></span>\n<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">body</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">readAllChunks</span><span style="color: #C9D1D9">(body)</span></span>\n<span class="line"><span style="color: #C9D1D9">    })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">readAllChunks</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">readableStream</span><span style="color: #C9D1D9">) {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">reader</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> readableStream.</span><span style="color: #D2A8FF">getReader</span><span style="color: #C9D1D9">()</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">) {</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #79C0FF">done</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">value</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> reader.</span><span style="color: #D2A8FF">read</span><span style="color: #C9D1D9">()</span></span>\n<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (done) {</span></span>\n<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">break</span></span>\n<span class="line"><span style="color: #C9D1D9">    }</span></span>\n<span class="line"><span style="color: #C9D1D9">    socket.</span><span style="color: #D2A8FF">send</span><span style="color: #C9D1D9">(value)</span></span>\n<span class="line"><span style="color: #C9D1D9">  }</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onmessage</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">message</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">received</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">JSON</span><span style="color: #C9D1D9">.</span><span style="color: #D2A8FF">parse</span><span style="color: #C9D1D9">(message.data)</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">transcript</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> received.channel.alternatives[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">].transcript</span></span>\n<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (transcript </span><span style="color: #FF7B72">&amp;&amp;</span><span style="color: #C9D1D9"> received.is_final) {</span></span>\n<span class="line"><span style="color: #C9D1D9">    document.</span><span style="color: #D2A8FF">querySelector</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;#captions&#39;</span><span style="color: #C9D1D9">).textContent </span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> transcript </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#39; &#39;</span></span>\n<span class="line"><span style="color: #C9D1D9">  }</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onclose</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">({ event: </span><span style="color: #A5D6FF">&#39;onclose&#39;</span><span style="color: #C9D1D9"> })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onerror</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">error</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>\n<span class="line"><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">({ event: </span><span style="color: #A5D6FF">&#39;onerror&#39;</span><span style="color: #C9D1D9">, error })</span></span>\n<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>\n<p>Have questions? We\u2019re happy to help <a href="https://twitter.com/DeepgramDevs">@DeepgramDevs.</a></p>';
}
const $$Astro = createAstro("/Users/sandrarodgers/web-next/blog/src/content/blog/posts/fetch-hosted-audio-streams-in-the-browser/index.md", "", "file:///Users/sandrarodgers/web-next/blog/");
const $$Index = createComponent(async ($$result, $$props, $$slots) => {
  const Astro2 = $$result.createAstro($$Astro, $$props, $$slots);
  Astro2.self = $$Index;
  new Slugger();
  return renderTemplate`<head>${renderHead($$result)}</head><p>Today we’ll look at how to fetch an audio stream from a URL, send the stream data to Deepgram, and receive transcriptions in return. This is particularly useful when you want to get live stream data and send it in real-time (and also receive a transcription back from Deepgram in real-time chunks).</p>
<p>This will require three main steps:</p>
<ol>
<li>Open a WebSocket channel to Deepgram</li>
<li>Request the hosted audio stream data from the URL where the stream is hosted (using Fetch)</li>
<li>Pass the stream in incremental chunks to Deepgram</li>
</ol>
<p>If you want to see the audio stream transcribed by Deepgram’s speech-to-text API, I recommend signing up for a free account and getting an API key <a href="https://console.deepgram.com/signup?jump=keys">here</a>.</p>
<h2 id="open-websocket-channel">Open WebSocket Channel</h2>
<p>The very first thing we need to do is connect to Deepgram with a browser WebSocket.</p>
<pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">socket</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">WebSocket</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;wss://api.deepgram.com/v1/listen&#39;</span><span style="color: #C9D1D9">, [</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">&#39;token&#39;</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">&#39;YOUR_DEEPGRAM_API_KEY&#39;</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">])</span></span></code></pre>
<p>Next we’ll write several event listeners. <strong>Events</strong> are actions that occur within a programmed system; the system is designed to inform us of those events so that we can write code in reaction to them. The WebSocket API includes several events that fire throughout the process of the socket opening, data being received, and the socket closing. We’ll use an event listener to react to those events.</p>
<p>We write this WebSocket logic first because then we can listen for the <code>onopen</code> event to take place, and once it does, we make the fetch request to receive the audio file:</p>
<pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onopen</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Fetch stream</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Send stream to Deepgram</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onmessage</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">message</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Receive transcript from Deepgram</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Do something with transcript</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onclose</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">({ event: </span><span style="color: #A5D6FF">&#39;onclose&#39;</span><span style="color: #C9D1D9"> })</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onerror</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">error</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">({ event: </span><span style="color: #A5D6FF">&#39;onerror&#39;</span><span style="color: #C9D1D9">, error })</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<h2 id="fetch-hosted-audio-stream">Fetch Hosted Audio Stream</h2>
<p>The next step will be to write the fetch request. The browser’s global <code>fetch()</code> method takes a string parameter that is the URL to where we will be making the request.</p>
<p>The method returns a promise, so we can chain <code>.then()</code> to wait for the response and get the response body.</p>
<pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onopen</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">url</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">&#39;https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">fetch</span><span style="color: #C9D1D9">(url)</span></span>
<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">response</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> response.body)</span></span>
<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">body</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #8B949E">// Send stream to Deepgram</span></span>
<span class="line"><span style="color: #C9D1D9">    })</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<h2 id="read-chunks-and-send-to-deepgram">Read Chunks and Send to Deepgram</h2>
<p>The <code>response.body</code> we receive from the URL will be a <code>ReadableStream</code>, which is a “readable stream of byte data” (<a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream">Mozilla</a>). This just means it is data that can be read. And in order to read the data, we must break it down - similar to the way a human must break a sentence down into words in order to comprehend its meaning.</p>
<p>How do we break down the stream data? The Streams API was created for this purpose. We’ll use it to take the stream and break it into <strong>chunks</strong>, which are the single pieces of data that are written to or read from a stream.</p>
<p>We can write a function to consume the readable stream and turn it into chunks to send to Deepgram. There are different ways to do this, but all of them will need to do the following:</p>
<ol>
<li>Create a <a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStreamDefaultReader">reader</a> using the <code>getReader()</code> method</li>
<li>Use the <code>read()</code> method of the reader interface to get access to each chunk in the queue (returned as a promise)</li>
</ol>
<p>Here is one way to write this function:</p>
<pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">readAllChunks</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">readableStream</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// Create reader:</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">reader</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> readableStream.</span><span style="color: #D2A8FF">getReader</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// Read chunks:</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #79C0FF">done</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">value</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> reader.</span><span style="color: #D2A8FF">read</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (done) {</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">break</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// Send chunks to Deepgram:</span></span>
<span class="line"><span style="color: #C9D1D9">    socket.</span><span style="color: #D2A8FF">send</span><span style="color: #C9D1D9">(value)</span></span>
<span class="line"><span style="color: #C9D1D9">  }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>Since the <code>.read()</code> method returns a promise that resolves to an object, we can destructure that object into its two properties: <code>done</code> and <code>value</code>. Then we can send that value on to Deepgram for transcription.</p>
<p>The Streams API specification provides <a href="https://streams.spec.whatwg.org/#rs-intro">other useful examples</a> for how to consume a <code>ReadableStream</code>.</p>
<p>Now that we have the logic to read the stream as chunks, we need to invoke the function and pass in the readable stream:</p>
<pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onopen</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">url</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">&#39;https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">fetch</span><span style="color: #C9D1D9">(url)</span></span>
<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">response</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> response.body)</span></span>
<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">body</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #8B949E">// Invoke function that sends readable stream:</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">readAllChunks</span><span style="color: #C9D1D9">(body)</span></span>
<span class="line"><span style="color: #C9D1D9">    })</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<h2 id="finishing-up">Finishing Up</h2>
<p>We have accomplished what we set out to do, which is to get a hosted audio stream and send it to Deepgram to be transcribed in realtime. When the transcript is returned, we can do whatever it is we intended to do with it.</p>
<p>Here’s the code in its entirety. I’ve also included <a href="https://stackblitz.com/edit/web-platform-v9nyiq?file=script.js,index.html">an example</a> in my Stackblitz account that puts the text from the stream onto the browser page. Be sure to add an API key to make it work.</p>
<pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">socket</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">WebSocket</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;wss://api.deepgram.com/v1/listen&#39;</span><span style="color: #C9D1D9">, [</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">&#39;token&#39;</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">&#39;YOUR_DEEPGRAM_API_KEY&#39;</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onopen</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">url</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">&#39;https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk&#39;</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">fetch</span><span style="color: #C9D1D9">(url)</span></span>
<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">response</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> response.body)</span></span>
<span class="line"><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">body</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">readAllChunks</span><span style="color: #C9D1D9">(body)</span></span>
<span class="line"><span style="color: #C9D1D9">    })</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">readAllChunks</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">readableStream</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">reader</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> readableStream.</span><span style="color: #D2A8FF">getReader</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #79C0FF">done</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">value</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> reader.</span><span style="color: #D2A8FF">read</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (done) {</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">break</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">    socket.</span><span style="color: #D2A8FF">send</span><span style="color: #C9D1D9">(value)</span></span>
<span class="line"><span style="color: #C9D1D9">  }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onmessage</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">message</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">received</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">JSON</span><span style="color: #C9D1D9">.</span><span style="color: #D2A8FF">parse</span><span style="color: #C9D1D9">(message.data)</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">transcript</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> received.channel.alternatives[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">].transcript</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (transcript </span><span style="color: #FF7B72">&amp;&amp;</span><span style="color: #C9D1D9"> received.is_final) {</span></span>
<span class="line"><span style="color: #C9D1D9">    document.</span><span style="color: #D2A8FF">querySelector</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;#captions&#39;</span><span style="color: #C9D1D9">).textContent </span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> transcript </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#39; &#39;</span></span>
<span class="line"><span style="color: #C9D1D9">  }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onclose</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> () </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">({ event: </span><span style="color: #A5D6FF">&#39;onclose&#39;</span><span style="color: #C9D1D9"> })</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">socket.</span><span style="color: #D2A8FF">onerror</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">error</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">({ event: </span><span style="color: #A5D6FF">&#39;onerror&#39;</span><span style="color: #C9D1D9">, error })</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p>Have questions? We’re happy to help <a href="https://twitter.com/DeepgramDevs">@DeepgramDevs.</a></p>`;
}, "/Users/sandrarodgers/web-next/blog/src/content/blog/posts/fetch-hosted-audio-streams-in-the-browser/index.md");

export { compiledContent, $$Index as default, frontmatter, metadata, rawContent };
