---
import ContrastSection from "../shared/components/decoration/ContrastSection.astro";
import Layout from "../layouts/Default.astro";
import Hero from "../components/homepage/Hero.astro";
import PrimarySection from "../shared/components/layout/PrimarySection.astro";
import HasAside from "../shared/components/layout/HasAside.astro";
import CategoryList from "../shared/components/nav/CategoryList.astro";
import CategorySection from "../components/homepage/CategorySectionSB.astro";
import Link from "../shared/components/general/Link.astro";
import JsonLD from "../shared/components/meta/JsonLD.astro";
import WhitepaperPromo from "../shared/components/global/WhitepaperPromo.astro";
import { useStoryblokApi } from "@storyblok/astro";

const sbApi = useStoryblokApi();

const { data: allPosts } = await sbApi.get("cdn/stories", {
	by_slugs: "blog-posts/*",
});

const sortedPosts = allPosts.stories.sort((a, b) => {
	const aDate = new Date(b.content.first_published_at);
	const bDate = new Date(a.content.first_published_at);
	return aDate.getTime() - bDate.getTime();
});

const { data: featured } = await sbApi.get("cdn/stories", {
	by_slugs: "featured-posts",
});
const featuredData = featured.stories[0].content;
const [featuredPost] = allPosts.stories.filter((post) => {
	return post.uuid === featuredData.Featured.id;
});

const homepagePosts = allPosts.stories.filter((post) => {
	return featuredData.Homepage.some((id) => id === post.uuid);
});

const otherPosts = sortedPosts.filter((post) => {
	return ![featuredPost, ...homepagePosts].some((f) => {
		return f.uuid === post.uuid;
	});
});

const latestPosts = otherPosts.splice(0, 2);
const { data } = await sbApi.get("cdn/stories", {
	by_slugs: "categories/*",
});
const categories = data.stories;

// build json schema object
const schema = {
	"@context": "https://schema.org",
	"@type": "BreadcrumbList",
	itemListElement: [
		{
			"@type": "ListItem",
			position: 1,
			name: "Deepgram Home",
			item: "https://deepgram.com",
		},
		{
			"@type": "ListItem",
			position: 2,
			name: "Blog",
		},
	],
};
---

<Layout>
	<JsonLD slot="json:ld" {schema} />

	<ContrastSection contrast="cloud" background="white" class="bg-sound-wave-cloud-dark" bottomDivider="eclipse-divider" bottomOverlay>
		<PrimarySection class="pt-[7rem] md:pt-[7.33203125rem] lg:pt-[7.6640625rem] xl:pt-[8.328125rem]">
			<Hero title="Deepgram Blog ⚡️" featured={featuredPost} homepage={homepagePosts} latest={latestPosts} />
		</PrimarySection>
	</ContrastSection>
	<PrimarySection class="mt-32 xl:mt-52">
		<HasAside>
			<CategoryList slot="aside" />
			{categories &&
				categories.map((category, index) => (
					<>
						<CategorySection category={category} />
						{index === 0 && (
							<div class="mb-32">
								<WhitepaperPromo whitepaper="latest" />
							</div>
						)}
					</>
				))}
			<center class="-mt-10 mb-20">
				<Link href="/posts" icon="arrow-right" iconSuffix class="button button--secondary button--small">View All</Link>
			</center>
		</HasAside>
	</PrimarySection>
</Layout>
