---
import PrimarySection from "../../../shared/components/layout/PrimarySection.astro";
import Layout from "../../../layouts/Default.astro";
import GeneralPostsPage from "../../../components/posts/GeneralPostsPage.astro";
import BlogCardList from "../../../shared/components/lists/BlogCardList.astro";
import BlogCard from "../../../shared/components/cards/BlogCard.astro";
import HasAside from "../../../shared/components/layout/HasAside.astro";
import CategoryList from "../../../shared/components/nav/CategoryList.astro";
import WhitepaperPromo from "../../../shared/components/promos/WhitepaperPromo.astro";
import whitepaperImg from "../../shared/assets/temp_images/black-quote.svg";
import Pagination from "../../../components/nav/Pagination.astro";

export async function getStaticPaths({ paginate }) {
	const categoryFiles = import.meta.glob("../../../content/blog/category/*.json");

	async function getCategories() {
		let paths = [];
		for (const path in categoryFiles) {
			const category = await categoryFiles[path]();
			paths.push({ title: category.title, slug: path.split("/").pop().replace(".json", " ").trim() });
		}
		return paths;
	}

	const categories = await getCategories();
	const allPosts = await Astro.glob("../../../content/blog/posts/**/index.md");
	const sortedPosts = allPosts.sort((a, b) => new Date(b.frontmatter.date) - new Date(a.frontmatter.date));

	return categories.map((category) => {
		const posts = sortedPosts.filter((post) => {
			return post.frontmatter.category === category.slug;
		});

		return paginate(posts, {
			params: {
				category: category.slug,
			},
			pageSize: 18,
			props: {
				title: category.title,
				slug: category.slug,
				size: 18,
			},
		});
	});
}

const { title, page, slug, size } = Astro.props;
---

<Layout>
	<PrimarySection>
		<a href="/tags" class="inline-block py-4 md:py-6 lg:py-8 xl:py-10">&lt;- All categories</a>
		<h1 class="mb-8">Deepgram Blog ⚡️</h1>
		<h2 class="mb-8">{`All posts tagged with #${title}`}</h2>
		<HasAside>
			<CategoryList slot="aside" />
			{page.data.length > 0 && (
				<>
					<BlogCardList>{page.data && page.data.slice(0, 9).map((post) => <BlogCard post={post} />)}</BlogCardList>
					{page.data.length > size && (
						<div class="my-24">
							<WhitepaperPromo
								title="How to Make Your Application Voice-Ready"
								theme="black"
								backgroundImage={whitepaperImg}
								formProps={[
									{ label: "Name (first and last)", placeholder: "Your name" },
									{ label: "Work email", placeholder: "you@company.com", type: "email" },
									{ label: "Role", placeholder: "Role/Title" },
								]}
								buttonText="Download"
							/>
						</div>
					)}
					<div class="mb-24">
						<BlogCardList>{page.data && page.data.slice(9, 18).map((post) => <BlogCard post={post} />)}</BlogCardList>
					</div>
				</>
			)}
			<Pagination page={page} slug={`categories/${slug}`} />
		</HasAside>
	</PrimarySection>
</Layout>
